viewport:width=device-width,initial-scale=1

目录

[TOC]

##计算机网络
###Ch3数据链路层

分组怎样从一个主机不经过路由器传送到另一个主机

使用的信道有以下两种基本类型

+ 点对点信道:使用一对一的点对点通信方式
	- PPP协议Point-to-Point Protocol 点对点协议
+ 广播信道:使用一对多的广播通信方式
	- 广播信道上连接的主机很多,必须使用专用的共享信道协议来协调这些主机的数据发送
	CSMA/CD协议Carrier Sense Multiple Access with Collision Detection 载波监听多点介入/碰撞检测协议

主要内容

+ 点对点信道和广播信道的特点,
这两种信道使用的协议的特点
+ 数据链路层的3个基本问题
	- 封装成帧
	- 透明传输
	- 差错检测
+ 以太网MAC层的硬件地址
+ 适配器,转发器,集线器,网桥,以太网交换机的作用以及使用场合	


####3.1使用点对点信道的数据链路层
#####数据链路和帧
数据链路

点对点信道的数据链路层进行通信的主要步骤

+ 发送方A把网络层交下来的IP数据报添加**首部和尾部**<u>封装成帧</u>
+ A把封装好的帧发送给接收方B 
+ 若结点B的数据链路层收到的帧无差错,则从收到的帧中提取IP数据报上交给上面的网络层
否则丢弃这个帧
#####三个基本问题
1. 封装成帧:IP数据报前后分别添加首部和尾部构成了帧
接收端在收到物理层上交的比特流后,根据首部和尾部的标记从收到的比特流中识别帧的开始和结束
	- 首部和尾部的一个重要作用就是进行**帧定界**
	- 每一种链路层协议都规定了所能传送的帧的数据部分的长度上限<u>最大传送单元</u>
		+ MTU,Maximum Transfer Unit
	- 当数据是由可打印的ASCII码组成时,帧定界可以使用特殊的帧定界符
		+ SOH,start of  header,01H
		+ ENT,end of tranmission,04H		
2. 透明传输:无论什么样的比特组合的数据都能够通过数据链路层
当数据部分是非ASCII码的文本文件时,可能和帧定界符发生冲突,使得帧被错误的定界,引起数据传输错误
采取的解决措施
	- **字节填充/字符填充**:转义字符'ESC',1BH
3. (比特)差错检测:
比特差错:1变成了0,0变成了1...
在数据链路层广泛使用了循环冗余检验的检错技术(也可以采取其他技术)
	- 循环冗余检验原理
	......
	- 仅仅使用循环冗余检验,只能做到对帧的无差错接受

**凡是接收端数据链路层接受的帧均无差错**

传输差错可以分为两大类

+ 基本的比特差错
+ 帧没有出现比特差错,出现了
	- 帧丢失
	- 帧重复
	- 帧失序
	这些差错都是CRC解决不了的

所以,**在数据链路层使用CRC检验,能够实现无比特差错的传输,但这并不是可靠传输**	
	- 可靠传输要求发送端发送什么,接收端就收到什么

+ 对于通信质量好的有线传输链路,不适用确认和重传机制,不要求数据链路层向上提供可靠传输服务
+ 对于通信质量差的无线传输链路,使用确认和重传机制,向上提供可靠传输服务

在通信路线质量差的年代,数据链路层使用可靠传输协议HDLC高级数据链路控制协议
####3.2点对点协议PPP
PPP:用户计算机和ISP进行通信时所使用的数据链路层协议
#####PPP协议的特点

1. 应满足的需求
	+ 简单
	+ 封装成帧
	+ 透明性
	+ 多种网络层协议:在同一条物理链路上同时支持多种网络层协议(IP/IPX)
	+ 多种类型链路:能在多种类型的链路上运行(串行的,并行的,同步的,异步的,光的,点的...)
		- 一个适应多种类型链路的典型例子PPPoE(over Ethernet)
	+ 差错检测
	+ 检测连接状态
	+ 最大传送单元MTU默认值:1500字节
		- MTU只是数据部分的最大长度,帧的长度还要算上头部尾部
	+ 网络层地址协商
	+ 数据压缩协商
PPP协议只支持全双工链路
2. 协议的组成
	+ IP数据报封装的方法
	+ 用来建立,配置,测试数据链路连接的链路控制协议LCP(link control protocol)
	+ 一套网络控制协议NCT(network control protocol)	
#####PPP协议的帧格式
![PPP帧的格式][0]

1. 各字段的意义
	+ 首部的第一个字段和尾部的第二个字段都是标志字段F(flag),就是帧的定界符
		- 连续两帧之间共用一个定界符;如果出现连续的两个标志字段,表示是空帧,应丢弃
	+ A,C字段固定...
	+ 首部的第四个字段是2字节的协议字段
		- 0x0021:表示信息部分是IP数据报
		- 0xC021:表示信息部分是LCP的数据
		- 0x8021:表示信息部分是网络控制数据
	+ 尾部的第一个字段,2个字节,是使用CRC的帧检验序列FCS
	+ 信息字段长度可变,不超过**1500**字节
2. 字节填充(PPP使用异步传输)
转义符定为0x7D
信息字段中
	+ 出现定界符0x7E时,转变成2字节序列(7D5EH)
	+ 出现转义符号0x7D时,转变为2字节序列(7D5DH)
	+ 出现ASCII码的控制字符时,前面加一个0x7D
3. 零比特填充(PPP使用同步传输)
	+ 发送端扫描整个信息字段,只要发现5个连续1,就填入1个0
	+ 接收端反向处理
#####PPP协议的工作状态
一开始是怎样被初始化的,?
![PPP状态转换][1]
PPP链路的起始和终止状态永远是链路静止状态,这时用户PC和ISP的路由器之间不存在物理层的连接

1. 建立物理层的连接,进入<u>链路建立</u>状态
2. LCP开始协商一些配置选项,发送LCP的配置请求帧(configure-request)
(对应前边帧的格式中首部第四个字段设为0xC021)
配置以下一些内容
	+ 最大帧长
	+ 所用的鉴别协议,不适用PPP帧中首部的那两个没意义的字段
	+ 另一端可以发送一下几种 响应
		- 配置确认帧:所有选型接受
		- 配置否认帧:所有选型理解但不能接受
		- 配置拒绝帧:选型有的无法识别或不能接受,需要协商
	+ 根据协商的结果,
		- 协商失败则回到了链路静止状态
3. 协商成功后建立了LCP链路,进入<u>鉴别</u>状态
4. 鉴别成功进入网络协议状态
5. 网络层配置完毕后,<u>链路打开</u>

根据上述流程,PPP协议已不是纯粹的数据链路层协议,还包含了物理层和网络层的内容
####3.3使用广播信道的数据链路层
#####局域网的数据链路层
局域网的工作层次跨越了数据链路层和物理层

局域网按网络拓扑分类

+ 星形网
+ 环形网
+ 总线网

共享信道如何使众多用户合理方便的共享通信媒体资源

+ 静态划分信道:FDM,TDM,WDM,CDM:用户只要分配了信道就不会和其他用户发生冲突
+ 动态媒体介入控制/多点介入multipleaccess:信道并非在用户通信时固定分配给用户
	- **随机接入**:所有用户可随机发送信息
		+ 如果恰有两个或更多用户在同一时刻发送信息,那么在共享媒体上就发生了碰撞
		因此必须有解决碰撞的协议
	- **受控接入**:用户发送信息服从一定的控制
		+ 代表分散控制的令牌环局域网
		+ 集中控制的多点线路探询/轮询

**传统以太网**		

1. 历史:以太网的两个标准,逻辑链路控制LLC,媒体接入控制MAC
2. 适配器的作用:计算机通过适配器和局域网进行通信
适配器上面装有处理器和存储器
适配器接收和发送各种帧时不适用计算机的CPU
计算机的硬件地址就在适配器的ROM中
#####CSMA/CD协议
总线的特点是当一台计算机发送数据时,总线上的所有计算机都能检测到这个数据,这也是所谓的广播通信
但是我们可能需要一对一而不是一对多通信
所以如何在总线上实现一对一通信,?根据MAC地址
以太网

+ 采用无连接的工作方式,:不必建立连接直接发送数据,发送的数据不编号不要求确认
**提供的服务是尽最大努力交付,即不可靠交付**
差错帧是否重传由上层决定,(重传的帧以太网并不知道是重传的...)
以太网采用最简单的随机接入
**在同一时间内只能允许一台计算机发送数据**
	- 协调方法:<u>载波监听多点接入/碰撞检测协议</u>
+ **以太网发送的数据都使用<u>曼彻斯特编码</u>的信号**

######CSMA/CD协议的要点
+ 多点接入:说明是总线型网络,许多计算机以多点接入的方式连接在一根总线上
+ 载波监听(检测信道):用电子技术检测总线上有没有其他计算机也在发送.
不管是在发送前还是发送中,每个站都必须不停的检测信道
	- 发送前检测是为了获得发送权
	- 发送中检测是为了及时发现碰撞
+ 碰撞检测(边发送边监听)
适配器在发送一帧数据期间监听信道

- <u>为什么发生碰撞就无法继续发送帧,?</u>

	+ 首先,什么是发生碰撞,?
		- 总线上至少两个数据信号在传递
	+ 发生碰撞总线上的信号就会失真,无法从中恢复有用的信息
	这样的信号对哪个站都是没用的,因为找不回发给自己的信息了
	+ 所以,发生碰撞的信号是无用信号

由以上,任何时刻总线上只能有一个信号在发送,那么显然,
**使用CSMA/CD协议的以太网只能进行半双工通信**
一个站不可能同时进行发送和接收
(发送的信号和接收的信号在总线上叠加在一起就成了失真信号)

- <u>为什么一个站在发送数据之前已经通过监听得知信道为空闲,还是会出现数据在总线上碰撞呢,?</u>
因为数据的载体电磁波在总线是以有限的速率传播的
A站检测到信道是空闲的,发送数据
此时B站同样检测到信道是空闲的,也发送数据
数据在同一条总线上传播,必然碰撞,此次发送数据就宣告无效

- <u>一个站发送数据之后,最迟要经过多长时间才能知道自己发送的数据和其他站发送的数据没有碰撞,?</u>
**这个时间是两倍的总线端到端传播时延(2$\tau$)**或总线的端到端往返传播时延
	+ $\tau$叫做单程端到端传播时延;端到端往返传播时延取其二倍
	+ 最迟:A检测到碰撞发生最长要经历多少时间,?
	+ <u>是否发生碰撞</u>
		- A发生的数据从离开A到到达目的地的这段时间内是否碰上其他信号
		B站发送的信号要想与A站发送的信号产生碰撞,
	+ <u>什么时候检测到碰撞</u>
		- 和A发送的数据信号发生碰撞的数据信号传播到A站的位置的时候

最坏的情况是总线两端的两个站之间的传播时延,局域网必须按照最坏的情况设计
	
传播时延对载波监听的影响
![CSMA/CD的一些重要时刻][2]
每一站在自己发送数据之后的一小段时间内,存在着遭遇碰撞的可能性
这一段时间是不确定,<u>取决于另一个发送数据的站到本站的距离</u>
**最先**发送数据帧的A站,在发送数据帧后**至多**经过时间$2\tau$就可知道所发送的数据是否遭受了碰撞

把以太网端到端往返时间$2\tau$称为**争用期**(contention period),又称为碰撞窗口(collision window)
**一个站在发送完数据后,只有通过争用期的考验,即经过争用期这段时间还没有检测到碰撞,
就可以肯定数据从发送至到达目的站,没有遭遇碰撞**,这时,就可以放心把这一帧数据发送完毕
######截断二进制指数退避算法
以太网使用截断二进制指数退避算法来确定碰撞后重传的时机
**让发生碰撞的站在停止发送数据后,推迟/退避一个随机的时间**

1. 基本退避时间为争用期$2\tau$
	+ 具体的争用期时间为$51.2\mu s$
2. 从离散的整数集合$[0,1,\cdots,(2^k-1)]中随机取出一个数,记为r.\\\
重传应退后的时间就是r倍的争用期\\\
k=Min[重传次数,10]$
	+ $当重传次数不超过10的时候,参数k等于重传次数,超过10次重传时,k=10$
3. 当重传达到16次仍然不能成功时,丢弃该帧,向上层报告

适配器每发送一个帧,就执行一次CSMA/CD算法

为了避免<u>数据在争用期内就发送完毕了/检测到碰撞时数据已经发送完毕</u>这样的情况
**以太网规定了一个最短帧长64字节/512bit**

+ 对应于$10Mb/s的以太网在51.2\tau s的时间内发送的数据位数$
+ 如果发送的数据帧没有64Byte这么大,就要填充一些字节
+ 凡是长度小于64字节的帧一定是检测到了碰撞而停止发送的帧,所以应当立即丢弃
######强化碰撞
当发送数据的站一旦发现了碰撞时,除了立即停止发送数据外,还要再继续发送32/48Byte的人为干扰信号
**以便让所有用户都知道现在已经发生了碰撞**
######帧间最小间隔
以太网规定帧间最小间隔为$9.6\tau s$
	+ 对于$10Mb/s的以太网,相当于96比特时间$
**这是为了使刚刚收到数据帧的站的接收缓存来得及清理,为接收下一帧做好准备**	
######要点归纳

+ 准备发送:适配器从网络层获得分组,加上首部和尾部组成以太网帧,放入适配器缓存中
发送之前**先检测信道**
+ 检测信道:96比特时间内信道空闲
+ 边发送边监听
	- 发送成功
	- 发送失败
		+ 按算法重传
		+ 停止

**以太网每发送完一帧,一定要暂时保留一下**
因为发生了碰撞要重传
####4.使用广播信道的以太网
10BASE-T

+ 10:10Mb/s
+ BASE:连接线上的信号是基带信号
+ T:双绞线

#####使用集线器的星形拓扑
**集线器hub**
特点

+ 表面看,使用集线器物理上是一个星型网但是
**使用集线器的以太网在逻辑上还是一个总线网**
各站共享逻辑上的总线,使用CSMA/CD协议,
+ 集线器有许多接口
+ 集线器工作在物理层:简单转发比特,不进行碰撞检测
同一个时刻至多允许一个站发送数据

每个站需要两队双绞线,一个用于发送,一个用于接收
每个站到集线器的距离不超过100m
#####以太网的信道利用率
**成功发送一个帧需要占用信道的时间为$T_0+\tau$**
发送一帧所需的平均时间还要算上发生碰撞后的退避时间

+ $T_0+\tau$是一帧的最后一个数据到达目的站的时间
也正是发送一帧占用信道的时间
在以太网中定义了参数$a,是以太网单程端到端延时\tau与帧的发送时间T_0之比\\\
a=\frac{\tau}{T_0}$	
#####以太网的MAC层
######MAC层的硬件地址
48位

发往本站的帧

+ 单播:一对一
+ 广播:一对全体
+ 多播:一对多

以太网适配器的混杂方式(promiscuous mode)
######MAC帧的格式
以太网的MAC帧格式有两种,使用最多的是以太网V2的MAC帧格式
![以太网MAC格式][3]
**5个字段**

+ 前两个字段分别为6个字节长的目的地址和源地址字段
+ 第三个字段是2个字节的类型字段:用于标志上一层使用的什么网络层协议
	- 0x0800:上层是IP数据报
+ 第四个字段是数据字段,长度在$46到1500个字节之间$	
	- 46来自于CSMA/CD中要求的一帧不能少于64字节(否则还没过争用期数据就发送完毕了)
	$首部尾部18个字节,64=18+46$
		+ 数据报不足46个字节就会在数据字段**后边**加入一个整数字节的填充字段
	- 1500即MTU
+ 第五个字段是4字节的FCS

一些问题

+ <u>以太网帧时不定长的,MAC子层如何找到从接收到的以太网帧中取出多少字节的数据,?</u>
(**如何判断一帧长度**,根据曼彻斯特的自同步)
	- 以太网用曼彻斯特编码+一帧发送结束时电平不再变化
	根据这两点得知一帧结束,
		+ 再根据FCS长4个字节,就能得知数据报结束的位置
			- 根据帧开始定界符,就知道一帧从何处开始
				+ 再根据前三个字段长14个字节,就知道数据报开始的位置
+ <u>填充字段如何处理,?</u>
	- MAC帧把数据报/数据字段交给IP层,IP层通过比对IP数据报的长度字段和数据字段
	**来决定是否存在填充字段,进而决定是否丢弃**
+ <u>MAC帧进入物理层为什么要插入8个字节</u>
	- **为了接收端迅速实现位同步**
	从MAC子层向下传到物理层时还要在帧前插入8字节(有硬件生成)
	由两个字段构成
		+ 第一个字段:7个字节的前同步码,1和0交替码
		**使接收端的适配器在接收MAC帧时能够迅速调制其时钟频率,使它和发送端时钟同步**
			- 如果不发送这个字段,MAC帧前面的若干位就无法正确接收
		+ 第二个字段:**帧开始定界符**:10101011
		前6位和前同步码作用一样,最后两个连续的1表示一帧开始
	- 使用SONET/SDH进行同步则不需要前同步码,
	因为同步传输时收发双方的位同步是一直保持的
+ 以太网上数据以帧为单位传送.以太网发送的各个帧之间有一定间隙
因此**只要找到帧开始定界符,后面的连续到达的比特流就同属于一个MAC帧**
可见
	- 以太网不需要使用帧结束定界符
	- 不需要使用字节插入来保证透明传输

**无效MAC帧**

+ 帧长度不是整数
+ 用FCS检验有差错
+ 收到的帧数据字段长度不在46-1500之间/帧长度不在64-1518之间

####4.扩展的以太网
#####在物理层扩展以太网:连接集线器
10BASE-T双绞线以太网每个站到集线器的距离不超过100m,
则通信的两个站之间距离不超过200m
否则信号经过铜线的传输就会衰减到使CSMA/CD协议无法正常工作

+ **使用光纤和光纤调制解调器可以扩展主机和集线器之间的距离**
很容易地使主机和几公里以外的集线器相连接,不会有信号衰减的过程
(光纤调制解调器完成光电转换)
+ 使用多个集线器可以连接覆盖更大范围的多级星型结构的以太网
	- 优点:物理上扩大了以太网的覆盖范围
	- 缺点:降低了数据率
		+ 把多个**碰撞域**(collision domain)变成了一个碰撞域,扩大了影响范围
			- 本来各个碰撞域可以独立同时工作,现在一个时刻只能有一个工作
		+ 不同数据率的以太网使用集线器互连起来,只能工作在最低的数据率

#####在数据链路层扩展以太网:使用网桥
在数据链路层扩展以太网要使用网桥(bridge)
**网桥工作在数据链路层**,它根据MAC帧的目的地址对收到的帧进行<u>**转发和过滤**</u>(丢弃)
######网桥的内部结构
**网桥依靠转发表来转发帧**
通过内部接口管理软件和网桥协议实体完成工作

- 网桥的好处
	+ 过滤通信量,增大吞吐量
	+ 扩大了物理范围
	+ 提高了可靠性
	+ 可互连不同物理层,不同MAC子层和不同速率
- 网桥的缺点
	+ 对接收的帧要存储和查找转发表,然后转发,转发之前要执行CSMA/CD算法
	**增加了时延**
	+ 当网络符合很重时,可能因网桥缓存溢出产生**帧丢失**的现象
	+ **广播风暴**

**网桥在转发帧时,不改变帧的源地址**	
######透明网桥
透明:以太网上的站点看不见以太网上的网桥
透明网桥即插即用,**不用人工配置,网桥就能工作**
(使用了自学习算法)

**自学习算法**
原理:若从某个站A发出的帧从接口x进入了某个网桥,那么从这个接口出发沿着相反的方向一定可把一个帧传送到A

从某个接口x收到了源地址为A的帧,则x是通向A的出口

通过收到帧建立<u>MAC地址和接口号的对应关系</u>,把这个关系用于转发帧的过程

集线器工作在物理层单纯的转发数据
网桥工作在数据链路层,采用**存储转发**的工作方式
(所以网桥会丢弃CRC检验有错的帧,长度不对(过长/过短)的帧)
网桥丢弃错误的帧之后存储转发:
网桥的自学习和转发过程
![网桥自学习][4]
一开始网桥的转发表是空的

+ $A\rightarrow B$:网桥收到一帧,
	- 按源地址查找转发表,
		+ 没有,则记录之:进入的接口号,地址,时间;有则更新之
		+ 按图中,网桥1的转发表中给地址A建立对应项;
	- 按目的地址查找转发表
		+ 若没有目的地址的记录项,就通过除接收此帧接口外的所有其他接口转发出去
		+ 按图中,网桥1中没有地址B的记录项,就把帧转发到了右边接着到了网桥2,
			- 网桥2没有A的记录项,就记录了地址A,
			没有B的记录项,就从其他接口处转发了帧
		+ 若有此目的地址的记录项
			- 接口号和进入的接口号一样,**丢弃此帧**
				+ 一样说明不用转发就能收到
			- 不一样,按记录项中接口号转发
+ $F\rightarrow C$
	- 按图中F向C发帧,网桥2收到此帧,
		+ 因为没有源地址的记录项,所以记录F地址
		+ 没有目的地址的记录项,在所有其他接口中转发
			- 帧正确抵达
			- 帧同时也会抵达网桥1
				+ 网桥1会记录F地址,接着在其他接口转发帧
+ $B\rightarrow A$
	- 按图中,网桥1收到此帧
		1. 查源地址,无记录,记录之,得B地址
		2. 查目的地址,有记录,且接口号正是接收接口号-->丢弃之


如果网路上的每一个站都发送过帧,那么每一个站的地址最终都会记录在转发表上
**转发表还要登记进入网桥的时间**用于更新转发表
使转发表保留网路拓扑的最新状态信息

网桥自学习和转发帧的一般步骤

+ (1)自学习:查源地址
	- 没有则记录之
	- 有则更新之
+ (2)转发帧:查目的地址
	- 没有则通过**所有其他**接口转发
	- 有
		+ 接收接口和转发接口号一样,丢弃
		+ 不一样,按号转发

网桥使用生成树算法避免帧在网络中不断的兜圈子
######源路由网桥
透明网球网络资源利用不充分
源路由网桥:由发送帧的源站负责路由选择
**在发送帧时,把详细的路由信息放在帧的首部中**

<u>源站如何知道路由,?</u>
通过广播方式向目的站发送一个发现帧作为探测之用
发现帧记录路由,到达目的站后原路返回,源站通过这些返回的携带路由信息的帧选择一个最佳路由

路由帧还可以帮助源站确定整个网络可以通过帧的最大长度,,???

**源路由网桥对主机是不透明的**
######多接口网桥-以太网交换机
交换式集线器switching hub/以太网交换机/第二次交换机
工作在数据链路层
(交换机没有准确的定义,是一个市场名词,混杂了网桥和路由器的功能)

**以太网交换机的实质就是一个多接口的网桥**

以太网 集线器 全双工
http://www.baike.com/wiki/%E5%85%A8%E5%8F%8C%E5%B7%A5%E6%8A%80%E6%9C%AF
http://network.51cto.com/art/201306/397379.htm
http://www.tcpipguide.com/free/index.htm

[0]:http://cjhgo.sinaapp.com/CS/ComputerNetwork/images/PPP_frame.gif
[1]:http://cjhgo.sinaapp.com/CS/ComputerNetwork/images/PPP_status.gif
[2]:http://cjhgo.sinaapp.com/CS/ComputerNetwork/images/CSMACD_event.gif
[3]:http://cjhgo.sinaapp.com/CS/ComputerNetwork/images/MAC_frame.gif
[4]:http://cjhgo.sinaapp.com/CS/ComputerNetwork/images/bridge.gif